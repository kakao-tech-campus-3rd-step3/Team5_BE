<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DailyQ 관리자 페이지</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0 auto; max-width: 1200px; padding: 20px; background-color: #f4f7f9; }
        h1, h2, h3 { color: #333; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white; margin-right: 5px; }
        button.delete { background-color: #dc3545; }
        button:hover { opacity: 0.8; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        form { margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 4px; background-color: #fdfdfd;}
        input, select, textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        .auth-container { border: 2px solid #dc3545; }

        .select-all-btn {
            font-size: 11px;
            padding: 3px 8px;
            margin-left: 10px;
            background-color: #6c757d;
            font-weight: normal;
        }

        .job-checkbox-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
        }

        .job-checkbox-list label {
            display: block;
            align-items: center;
            font-weight: normal;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            word-break: keep-all;
        }

        .job-checkbox-list label:hover {
            background-color: #f4f7f9;
        }

        .job-checkbox-list input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            margin-bottom: 0;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .job-checkbox-list label span {
            vertical-align: middle;
        }

        .modal-content form label {
            margin-top: 10px;
        }
        .modal-content form button[type="submit"] {
            margin-top: 15px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

<h1>DailyQ 관리자 페이지</h1>

<div class="container auth-container">
    <h2>인증 설정</h2>
    <label for="jwt-token">JWT Access Token</label>
    <input type="password" id="jwt-token" placeholder="관리자 계정의 Access Token을 여기에 붙여넣으세요.">
    <p>⚠️ 관리자 API를 호출하기 전에 반드시 토큰을 입력해야 합니다.</p>
</div>

<!-- 회원 관리 -->
<div class="container">
    <h2>회원 관리</h2>
    <button onclick="fetchUsers()">회원 목록 조회</button>
    <table id="users-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>이메일</th>
            <th>이름</th>
            <th>역할</th>
            <th>작업</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 직군/직업 관리 -->
<div class="container">
    <h2>직군 및 직업 관리</h2>
    <button onclick="fetchOccupationsAndJobs()">직군/직업 목록 조회</button>
    <h3>직군(Occupation)</h3>
    <form onsubmit="createOccupation(event)">
        <label for="new-occupation-name">새 직군 이름:</label>
        <input type="text" id="new-occupation-name" placeholder="새 직군 이름" required>
        <button type="submit">직군 추가</button>
    </form>
    <table id="occupations-table">
        <thead><tr><th>ID</th><th>직군명</th><th>작업</th></tr></thead>
        <tbody></tbody>
    </table>

    <h3 style="margin-top: 30px;">직업(Job)</h3>
    <form onsubmit="createJob(event)">
        <label for="new-job-name">새 직업 이름:</label>
        <input type="text" id="new-job-name" placeholder="새 직업 이름" required>
        <label for="new-job-occupation">상위 직군:</label>
        <select id="new-job-occupation" required>
            <option value="">-- 직군 선택 --</option>
        </select>
        <button type="submit">직업 추가</button>
    </form>
    <table id="jobs-table">
        <thead><tr><th>ID</th><th>직군명</th><th>상위 직군</th><th>작업</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<!-- 질문 관리 -->
<div class="container">
    <h2>질문 관리</h2>
    <button onclick="showQuestionModal()">새 질문 작성</button>
    <button onclick="fetchQuestions()">질문 목록 조회</button>
    <table id="questions-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>질문 내용</th>
            <th>타입</th>
            <th>활성화</th>
            <th>작업</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- 수정/생성 모달 -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    const API_BASE_URL = '/api/admin';

    function escapeHtml(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = text.toString();
        return div.innerHTML;
    }

    // 모든 fetch 요청에 JWT 헤더를 추가하는 래퍼 함수
    async function apiFetch(url, options = {}) {
        const token = document.getElementById('jwt-token').value;
        if (!token) {
            alert('JWT 토큰을 입력해주세요.');
            throw new Error('JWT Token is missing');
        }

        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers
        };

        try {
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { detail: await response.text() };
                }
                const errorMessage = `API Error (${response.status}): ${errorData.detail || 'Unknown error'}`;
                console.error('Fetch Error Detail:', errorData);
                throw new Error(errorMessage);
            }
            if (response.status === 204 || response.headers.get("content-length") === "0") {
                return; // 204 No Content 또는 내용이 없는 응답 처리
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch Error:', error);
            throw error;
        }
    }

    function closeModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    /* =========================
       User Management
       ========================= */
    async function fetchUsers() {
        try {
            const users = await apiFetch(`${API_BASE_URL}/users`);
            // ID 순으로 정렬
            users.sort((a, b) => a.userId - b.userId);
            const tableBody = document.querySelector('#users-table tbody');
            tableBody.innerHTML = '';
            users.forEach(user => {
                // XSS 방지: onclick 속성에 들어갈 문자열 이스케이프 (따옴표 처리)
                const escapedName = (user.name || '').replace(/'/g, "&#039;").replace(/"/g, "&quot;");
                const escapedRole = (user.role || '').replace(/'/g, "&#039;").replace(/"/g, "&quot;");

                tableBody.innerHTML += `
                    <tr>
                        <td>${user.userId}</td>
                        <!-- XSS 방지: 셀 내용 HTML 이스케이프 -->
                        <td>${escapeHtml(user.email)}</td>
                        <td>${escapeHtml(user.name)}</td>
                        <td>${escapeHtml(user.role)}</td>
                        <td>
                            <button onclick="showEditUserModal(${user.userId}, '${escapedName}', '${escapedRole}')">수정</button>
                            <button class="delete" onclick="deleteUser(${user.userId})">삭제</button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            alert('회원 목록 조회 실패: ' + error.message);
        }
    }

    function showEditUserModal(id, name, role) {
        const modalBody = document.getElementById('modal-body');
        // XSS 방지: value 속성에 들어갈 값 이스케이프
        const safeName = name.replace(/'/g, "&#039;").replace(/"/g, "&quot;");

        modalBody.innerHTML = `
            <h3>회원 정보 수정 (ID: ${id})</h3>
            <form onsubmit="updateUser(event, ${id})">
                <label for="edit-user-name">이름:</label>
                <input type="text" id="edit-user-name" value="${safeName}" required>
                <label for="edit-user-role">역할:</label>
                <select id="edit-user-role">
                    <option value="FREE" ${role === 'FREE' ? 'selected' : ''}>FREE</option>
                    <option value="PAID" ${role === 'PAID' ? 'selected' : ''}>PAID</option>
                    <option value="ADMIN" ${role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                </select>
                <button type="submit">수정 완료</button>
            </form>
        `;
        document.getElementById('edit-modal').style.display = 'block';
    }

    async function updateUser(event, id) {
        event.preventDefault();
        const name = document.getElementById('edit-user-name').value;
        const role = document.getElementById('edit-user-role').value;
        try {
            await apiFetch(`${API_BASE_URL}/users/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ name, role })
            });
            alert('회원 정보가 수정되었습니다.');
            closeModal();
            fetchUsers();
        } catch (error) {
            alert('회원 정보 수정 실패: ' + error.message);
        }
    }

    async function deleteUser(id) {
        if (window.prompt(`ID ${id} 회원을 삭제하려면 '삭제'라고 입력하세요.`) !== '삭제') {
            alert('입력이 일치하지 않아 취소되었습니다.');
            return;
        }
        try {
            await apiFetch(`${API_BASE_URL}/users/${id}`, { method: 'DELETE' });
            alert('회원이 삭제되었습니다.');
            fetchUsers();
        } catch (error) {
            alert('회원 삭제 실패: ' + error.message);
        }
    }

    /* =========================
       Occupation & Job Management
       ========================= */
    let allOccupations = [];
    let allJobs = [];

    async function fetchOccupationsAndJobs() {
        try {
            // 1. 직군 목록 조회
            const occupations = await apiFetch(`${API_BASE_URL}/occupations`);
            occupations.sort((a, b) => a.occupationId - b.occupationId);
            allOccupations = occupations;

            // 2. 전체 직업 목록 조회
            const jobs = await apiFetch(`${API_BASE_URL}/jobs`);
            jobs.sort((a, b) => a.jobId - b.jobId);
            allJobs = jobs;

            // 3. 직군 테이블 렌더링
            const occupationsTable = document.querySelector('#occupations-table tbody');
            occupationsTable.innerHTML = '';
            occupations.forEach(occ => {
                occupationsTable.innerHTML += `<tr><td>${occ.occupationId}</td><td>${escapeHtml(occ.occupationName)}</td><td><button class="delete" onclick="deleteOccupation(${occ.occupationId})">삭제</button></td></tr>`;
            });

            // 4. 직업 테이블 렌더링
            const jobsTable = document.querySelector('#jobs-table tbody');
            jobsTable.innerHTML = '';
            jobs.forEach(job => {
                jobsTable.innerHTML += `<tr>
                    <td>${job.jobId}</td>
                    <td>${escapeHtml(job.jobName)}</td>
                    <td>${escapeHtml(job.occupationName)}</td>
                    <td>
                        <button class="delete" onclick="deleteJob(${job.jobId})">삭제</button>
                    </td>
                </tr>`;
            });

            // 5. 직업 추가 폼의 select 옵션 채우기
            const occSelect = document.getElementById('new-job-occupation');
            occSelect.innerHTML = '<option value="">-- 직군 선택 --</option>' + occupations.map(o => `<option value="${o.occupationId}">${escapeHtml(o.occupationName)}</option>`).join('');
        } catch (e) {
            alert('직군/직업 목록 조회 실패: ' + e.message);
            throw e;
        }
    }

    async function createOccupation(event) {
        event.preventDefault();
        const nameInput = document.getElementById('new-occupation-name');
        try {
            await apiFetch(`${API_BASE_URL}/occupations`, { method: 'POST', body: JSON.stringify({ occupationName: nameInput.value }) });
            alert('직군이 추가되었습니다.');
            nameInput.value = '';
            fetchOccupationsAndJobs(); // 목록 새로고침
        } catch (e) {
            alert('직군 추가 실패: ' + e.message);
        }
    }

    async function deleteOccupation(id) {
        if (window.prompt(`ID ${id} 직군을 삭제하려면 '삭제'라고 입력하세요. (연결된 직업이 없어야 합니다)`) !== '삭제') {
            alert('취소되었습니다.');
            return;
        }
        try {
            await apiFetch(`${API_BASE_URL}/occupations/${id}`, { method: 'DELETE' });
            alert('직군이 삭제되었습니다.');
            fetchOccupationsAndJobs(); // 목록 새로고침
        } catch (e) {
            alert('직군 삭제 실패: ' + e.message);
        }
    }

    async function createJob(event) {
        event.preventDefault();
        const nameInput = document.getElementById('new-job-name');
        const occSelect = document.getElementById('new-job-occupation');

        if (!occSelect.value) {
            alert('상위 직군을 선택해야 합니다.');
            return;
        }

        try {
            const body = {
                jobName: nameInput.value,
                occupationId: Number(occSelect.value)
            };
            await apiFetch(`${API_BASE_URL}/jobs`, { method: 'POST', body: JSON.stringify(body) });
            alert('직업이 추가되었습니다.');
            nameInput.value = '';
            occSelect.value = '';
            fetchOccupationsAndJobs(); // 목록 새로고침
        } catch (e) {
            alert('직업 추가 실패: ' + e.message);
        }
    }

    async function deleteJob(id) {
        if (window.prompt(`ID ${id} 직업을 삭제하려면 '삭제'라고 입력하세요. (사용 중인 직업은 삭제할 수 없습니다)`) !== '삭제') {
            alert('취소되었습니다.');
            return;
        }
        try {
            await apiFetch(`${API_BASE_URL}/jobs/${id}`, { method: 'DELETE' });
            alert('직업이 삭제되었습니다.');
            fetchOccupationsAndJobs(); // 목록 새로고침
        } catch (e) {
            alert('직업 삭제 실패: ' + e.message);
        }
    }

    /* =========================
       Question Management
       ========================= */
    const questionTypes = ['TECH', 'INTRO', 'MOTIVATION', 'PERSONALITY'];

    async function showQuestionModal(id) {
        // 1. 모달을 띄우고 로딩 상태 표시
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = `<h3><span class="loader"></span> 데이터 불러오는 중...</h3>`;
        document.getElementById('edit-modal').style.display = 'block';

        try {
            let question = { questionText: '', questionType: 'TECH', enabled: true, jobIds: [] };

            // 2. (수정 시) 질문 상세 정보 불러오기
            if (id) {
                question = await apiFetch(`${API_BASE_URL}/questions/${id}`);
            }

            // 3. (필수) 직업/직군 목록이 없으면 불러오기
            if (allJobs.length === 0 || allOccupations.length === 0) {
                console.log("직업/직군 목록이 비어있어, 새로 조회합니다...");
                await fetchOccupationsAndJobs(); // 에러는 내부에서 alert 처리됨

                if (allJobs.length === 0) {
                    modalBody.innerHTML = `<h3><span style="color: red;">오류 발생</span></h3><p>직업 목록을 불러올 수 없습니다. JWT 토큰을 확인하고 '직군/직업 목록 조회'를 먼저 시도해주세요.</p><button type="button" onclick="closeModal()">닫기</button>`;
                    return;
                }
            }

            // 4. 모든 데이터가 준비되면 모달 내용 렌더링
            modalBody.innerHTML = `
                <h3>${id ? '질문 수정 (ID: ' + id + ')' : '새 질문 작성'}</h3>
                <form onsubmit="handleQuestionSubmit(event, ${id || null})">
                    <label for="question-text">질문 내용:</label>
                    <textarea id="question-text" rows="3" required>${escapeHtml(question.questionText)}</textarea>

                    <label for="question-type">질문 타입:</label>
                    <select id="question-type">
                        ${questionTypes.map(type => `<option value="${type}" ${type === question.questionType ? 'selected' : ''}>${type}</option>`).join('')}
                    </select>

                    <label>연결된 직업:
                        <button type="button" class="select-all-btn" onclick="toggleAllJobs(this, 'question-job-checkboxes')">전체 선택</button>
                    </label>

                    <div id="question-job-checkboxes" class="job-checkbox-list">
                        ${allJobs.map(job => `
                            <label>
                                <input type="checkbox" name="jobIds" value="${job.jobId}" ${question.jobIds && question.jobIds.includes(job.jobId) ? 'checked' : ''}>
                                <span>${escapeHtml(job.jobName)}</span>
                            </label>
                        `).join('')}
                    </div>

                    <label for="question-enabled">활성화 여부:</label>
                    <select id="question-enabled">
                        <option value="true" ${question.enabled ? 'selected' : ''}>활성</option>
                        <option value="false" ${!question.enabled ? 'selected' : ''}>비활성</option>
                    </select>

                    <button type="submit">${id ? '수정 완료' : '생성'}</button>
                </form>
            `;
        } catch (error) {
            modalBody.innerHTML = `<h3><span style="color: red;">오류 발생</span></h3><p>${escapeHtml(error.message)}</p><button type="button" onclick="closeModal()">닫기</button>`;
        }
    }

    function toggleAllJobs(button, listId) {
        const checkboxes = document.querySelectorAll(`#${listId} input[type="checkbox"]`);
        if (button.textContent === '전체 선택') {
            checkboxes.forEach(cb => cb.checked = true);
            button.textContent = '전체 해제';
        } else {
            checkboxes.forEach(cb => cb.checked = false);
            button.textContent = '전체 선택';
        }
    }

    async function fetchQuestions() {
        try {
            const questions = await apiFetch(`${API_BASE_URL}/questions`);
            // ID 순으로 정렬
            questions.sort((a, b) => a.questionId - b.questionId);
            const tableBody = document.querySelector('#questions-table tbody');
            tableBody.innerHTML = '';
            questions.forEach(q => {
                tableBody.innerHTML += `<tr>
                    <td>${q.questionId}</td>
                    <td>${escapeHtml(q.questionText)}</td>
                    <td>${escapeHtml(q.questionType)}</td>
                    <td>${q.enabled ? '✔️' : '❌'}</td>
                    <td>
                        <button onclick="showQuestionModal(${q.questionId})">수정</button>
                        <button class="delete" onclick="deleteQuestion(${q.questionId})">삭제</button>
                    </td>
                </tr>`;
            });
        } catch (e) {
            alert('질문 목록 조회 실패: ' + e.message);
        }
    }

    async function handleQuestionSubmit(event, id) {
        event.preventDefault();
        const isUpdate = id != null;

        const text = document.getElementById('question-text').value;
        const type = document.getElementById('question-type').value;
        const enabled = document.getElementById('question-enabled').value === 'true';
        const jobIds = Array.from(document.querySelectorAll('#question-job-checkboxes input:checked')).map(cb => Number(cb.value));

        if (jobIds.length === 0) {
            alert('하나 이상의 직업을 선택해야 합니다.');
            return;
        }

        const url = isUpdate ? `${API_BASE_URL}/questions/${id}` : `${API_BASE_URL}/questions`;
        const method = isUpdate ? 'PUT' : 'POST';

        const body = {
            questionText: text,
            questionType: type,
            enabled: enabled,
            jobIds: jobIds
        };

        try {
            await apiFetch(url, { method, body: JSON.stringify(body) });
            alert(`질문이 성공적으로 ${isUpdate ? '수정' : '생성'}되었습니다.`);
            closeModal();
            fetchQuestions(); // 목록 새로고침
        } catch (e) {
            alert(`질문 ${isUpdate ? '수정' : '생성'} 실패: ` + e.message);
        }
    }

    async function deleteQuestion(id) {
        if (window.prompt(`ID ${id} 질문을 삭제하려면 '삭제'라고 입력하세요. (연결된 답변이 없어야 합니다)`) !== '삭제') {
            alert('취소되었습니다.');
            return;
        }
        try {
            await apiFetch(`${API_BASE_URL}/questions/${id}`, { method: 'DELETE' });
            alert('질문이 삭제되었습니다.');
            fetchQuestions(); // 목록 새로고침
        } catch (e) {
            alert('질문 삭제 실패: ' + e.message);
        }
    }

    // 모달 바깥 영역 클릭 시 닫기
    window.onclick = function(event) {
        const modal = document.getElementById('edit-modal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // 페이지 로드 시 직업 목록을 미리 불러옵니다. (질문 모달에서 사용하기 위함)
    document.addEventListener('DOMContentLoaded', () => {
        const token = document.getElementById('jwt-token').value;
        if (!token) {
            console.log("페이지 로드 시 직군/직업 목록 조회를 생략합니다 (토큰이 아직 없습니다)");
            return ;
        }
        fetchOccupationsAndJobs().catch(() => {
            console.log("페이지 로드 시 직군/직업 목록 조회 실패 (토큰이 아직 없을 수 있습니다)");
        })
    });
</script>

</body>
</html>

