<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DailyQ 관리자 페이지</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0 auto; max-width: 1200px; padding: 20px; background-color: #f4f7f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white; margin-right: 5px; }
        button.delete { background-color: #dc3545; }
        button:hover { opacity: 0.8; }
        form { margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 4px; background-color: #fdfdfd;}
        input, select, textarea { width: calc(100% - 20px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        .auth-container { border: 2px solid #dc3545; }
        #job-checkboxes { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>

<h1>DailyQ 관리자 페이지</h1>

<div class="container auth-container">
    <h2>인증 설정</h2>
    <label for="jwt-token">JWT Access Token</label>
    <input type="text" id="jwt-token" placeholder="관리자 계정의 Access Token을 여기에 붙여넣으세요.">
    <p>⚠️ 관리자 API를 호출하기 전에 반드시 토큰을 입력해야 합니다.</p>
</div>

<div class="container">
    <h2>회원 관리</h2>
    <button onclick="fetchUsers()">회원 목록 조회</button>
    <table id="users-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>이메일</th>
            <th>이름</th>
            <th>역할</th>
            <th>작업</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="edit-user-form" style="display:none;">
        <h3>회원 정보 수정</h3>
        <form onsubmit="updateUser(event)">
            <input type="hidden" id="edit-user-id">
            <label for="edit-user-name">이름:</label>
            <input type="text" id="edit-user-name" required>
            <label for="edit-user-role">역할:</label>
            <select id="edit-user-role">
                <option value="FREE">FREE</option>
                <option value="PAID">PAID</option>
                <option value="ADMIN">ADMIN</option>
            </select>
            <button type="submit">수정 완료</button>
            <button type="button" onclick="document.getElementById('edit-user-form').style.display='none'">취소</button>
        </form>
    </div>
</div>

<div class="container">
    <h2>직군 및 직업 관리</h2>
    <button onclick="fetchOccupationsAndJobs()">직군/직업 목록 조회</button>
    <h3>직군(Occupation)</h3>
    <form onsubmit="createOccupation(event)">
        <input type="text" id="new-occupation-name" placeholder="새 직군 이름" required>
        <button type="submit">직군 추가</button>
    </form>
    <table id="occupations-table">
        <thead><tr><th>ID</th><th>직군명</th><th>작업</th></tr></thead>
        <tbody></tbody>
    </table>

    <h3 style="margin-top: 30px;">직업(Job)</h3>
    <form onsubmit="createJob(event)">
        <input type="text" id="new-job-name" placeholder="새 직업 이름" required>
        <select id="new-job-occupation" required></select>
        <button type="submit">직업 추가</button>
    </form>
    <table id="jobs-table">
        <thead><tr><th>ID</th><th>직업명</th><th>상위 직군</th><th>작업</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<div class="container">
    <h2>질문 관리</h2>
    <button onclick="fetchAllJobsForQuestions(); document.getElementById('question-form-wrapper').style.display='block';">새 질문 작성</button>
    <button onclick="fetchQuestions()">질문 목록 조회</button>

    <div id="question-form-wrapper" style="display:none;">
        <h3 id="question-form-title">새 질문 작성</h3>
        <form onsubmit="handleQuestionSubmit(event)">
            <input type="hidden" id="edit-question-id">
            <label for="question-text">질문 내용:</label>
            <textarea id="question-text" rows="3" required></textarea>
            <label for="question-type">질문 타입:</label>
            <select id="question-type">
                <option value="TECH">TECH</option>
                <option value="INTRO">INTRO</option>
                <option value="MOTIVATION">MOTIVATION</option>
                <option value="PERSONALITY">PERSONALITY</option>
            </select>
            <label>연결된 직업 (하나 이상 선택):</label>
            <div id="job-checkboxes"></div>
            <label for="question-enabled">활성화 여부 (수정 시에만 적용):</label>
            <select id="question-enabled">
                <option value="true">활성</option>
                <option value="false">비활성</option>
            </select>
            <button type="submit" id="question-submit-btn">생성</button>
            <button type="button" onclick="resetQuestionForm()">취소</button>
        </form>
    </div>

    <table id="questions-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>질문 내용</th>
            <th>타입</th>
            <th>활성화</th>
            <th>작업</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


<script>
    const API_BASE_URL = '/api/admin';

    // --- 인증 헤더 ---
    function getAuthHeaders() {
        const token = document.getElementById('jwt-token').value;
        if (!token) {
            alert('JWT 토큰을 입력해주세요.');
            throw new Error('JWT Token is missing');
        }
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    // --- 유틸리티 ---
    async function apiFetch(url, options = {}) {
        try {
            const headers = getAuthHeaders();
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error (${response.status}): ${errorData.detail || 'Unknown error'}`);
            }
            // DELETE의 경우 content가 없을 수 있음
            if (response.status === 204) return;
            return await response.json();
        } catch (error) {
            console.error('Fetch Error:', error);
            alert(error.message);
            throw error; // 에러를 다시 던져서 호출한 쪽에서 처리할 수 있게 함
        }
    }


    /* =========================
       User Management
       ========================= */
    async function fetchUsers() {
        try {
            const users = await apiFetch(`${API_BASE_URL}/users`);
            const tableBody = document.querySelector('#users-table tbody');
            tableBody.innerHTML = '';
            users.forEach(user => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.email}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>
                            <button onclick="showEditUserForm(${user.userId}, '${user.name}', '${user.role}')">수정</button>
                            <button class="delete" onclick="deleteUser(${user.userId})">삭제</button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) { /* 에러는 apiFetch에서 처리 */ }
    }

    function showEditUserForm(id, name, role) {
        document.getElementById('edit-user-id').value = id;
        document.getElementById('edit-user-name').value = name;
        document.getElementById('edit-user-role').value = role;
        document.getElementById('edit-user-form').style.display = 'block';
    }

    async function updateUser(event) {
        event.preventDefault();
        const id = document.getElementById('edit-user-id').value;
        const name = document.getElementById('edit-user-name').value;
        const role = document.getElementById('edit-user-role').value;
        try {
            await apiFetch(`${API_BASE_URL}/users/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ name, role })
            });
            alert('회원 정보가 수정되었습니다.');
            document.getElementById('edit-user-form').style.display = 'none';
            fetchUsers();
        } catch (error) { /* 에러는 apiFetch에서 처리 */ }
    }

    async function deleteUser(id) {
        if (!confirm(`정말로 ID ${id} 회원을 삭제하시겠습니까?`)) return;
        try {
            await apiFetch(`${API_BASE_URL}/users/${id}`, { method: 'DELETE' });
            alert('회원이 삭제되었습니다.');
            fetchUsers();
        } catch (error) { /* 에러는 apiFetch에서 처리 */ }
    }


    /* =========================
       Occupation & Job Management
       ========================= */
    let allOccupations = [];
    let allJobs = [];

    async function fetchOccupationsAndJobs() {
        // 직군 조회 (이건 일반 API 사용)
        const token = document.getElementById('jwt-token').value;
        const occupations = await fetch('/api/occupations', { headers: {'Authorization': `Bearer ${token}`}}).then(res => res.json());
        allOccupations = occupations;
        const occupationsTable = document.querySelector('#occupations-table tbody');
        occupationsTable.innerHTML = '';
        occupations.forEach(occ => {
            occupationsTable.innerHTML += `
                <tr>
                    <td>${occ.occupationId}</td>
                    <td>${occ.occupationName}</td>
                    <td><button class="delete" onclick="deleteOccupation(${occ.occupationId})">삭제</button></td>
                </tr>
            `;
        });

        // 직업 조회 (모든 직군에 대해)
        const jobsTable = document.querySelector('#jobs-table tbody');
        jobsTable.innerHTML = '';
        allJobs = [];
        for(const occ of occupations) {
            const jobs = await fetch(`/api/occupations/${occ.occupationId}/jobs`, { headers: {'Authorization': `Bearer ${token}`}}).then(res => res.json());
            jobs.forEach(job => {
                allJobs.push(job);
                jobsTable.innerHTML += `
                    <tr>
                        <td>${job.jobId}</td>
                        <td>${job.jobName}</td>
                        <td>${occ.occupationName}</td>
                        <td><button class="delete" onclick="deleteJob(${job.jobId})">삭제</button></td>
                    </tr>
                `;
            });
        }

        // 직업 생성 폼의 직군 select 업데이트
        const occSelect = document.getElementById('new-job-occupation');
        occSelect.innerHTML = occupations.map(o => `<option value="${o.occupationId}">${o.occupationName}</option>`).join('');
    }

    async function createOccupation(event) {
        event.preventDefault();
        const nameInput = document.getElementById('new-occupation-name');
        try {
            await apiFetch(`${API_BASE_URL}/occupations`, {
                method: 'POST',
                body: JSON.stringify({ occupationName: nameInput.value })
            });
            alert('직군이 추가되었습니다.');
            nameInput.value = '';
            fetchOccupationsAndJobs();
        } catch (e) { /* 에러 처리 */ }
    }

    async function deleteOccupation(id) {
        if (!confirm(`ID ${id} 직군을 삭제하시겠습니까? 하위 직업이 있으면 실패합니다.`)) return;
        try {
            await apiFetch(`${API_BASE_URL}/occupations/${id}`, { method: 'DELETE' });
            alert('직군이 삭제되었습니다.');
            fetchOccupationsAndJobs();
        } catch (e) { /* 에러 처리 */ }
    }

    async function createJob(event) {
        event.preventDefault();
        const nameInput = document.getElementById('new-job-name');
        const occSelect = document.getElementById('new-job-occupation');
        try {
            await apiFetch(`${API_BASE_URL}/jobs`, {
                method: 'POST',
                body: JSON.stringify({ jobName: nameInput.value, occupationId: occSelect.value })
            });
            alert('직업이 추가되었습니다.');
            nameInput.value = '';
            fetchOccupationsAndJobs();
        } catch (e) { /* 에러 처리 */ }
    }

    async function deleteJob(id) {
        if (!confirm(`ID ${id} 직업을 삭제하시겠습니까?`)) return;
        try {
            await apiFetch(`${API_BASE_URL}/jobs/${id}`, { method: 'DELETE' });
            alert('직업이 삭제되었습니다.');
            fetchOccupationsAndJobs();
        } catch (e) { /* 에러 처리 */ }
    }


    /* =========================
       Question Management
       ========================= */
    async function fetchAllJobsForQuestions() {
        if (allJobs.length === 0) {
            await fetchOccupationsAndJobs();
        }
        const checkboxesDiv = document.getElementById('job-checkboxes');
        checkboxesDiv.innerHTML = allJobs.map(job => `
            <label>
                <input type="checkbox" name="jobIds" value="${job.jobId}">
                ${job.jobName}
            </label>
        `).join('<br>');
    }

    async function fetchQuestions() {
        try {
            const questions = await apiFetch(`${API_BASE_URL}/questions`);
            const tableBody = document.querySelector('#questions-table tbody');
            tableBody.innerHTML = '';
            questions.forEach(q => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${q.questionId}</td>
                        <td>${q.questionText}</td>
                        <td>${q.questionType}</td>
                        <td>${q.enabled ? '✔️' : '❌'}</td>
                        <td>
                            <button onclick="showEditQuestionForm(${q.questionId})">수정</button>
                            <button class="delete" onclick="deleteQuestion(${q.questionId})">삭제</button>
                        </td>
                    </tr>
                `;
            });
        } catch (e) { /* 에러 처리 */ }
    }

    function resetQuestionForm() {
        document.getElementById('question-form-wrapper').style.display = 'none';
        document.getElementById('question-form-title').innerText = '새 질문 작성';
        document.getElementById('question-submit-btn').innerText = '생성';
        document.getElementById('edit-question-id').value = '';
        document.getElementById('question-text').value = '';
        document.querySelectorAll('#job-checkboxes input').forEach(cb => cb.checked = false);
    }

    async function showEditQuestionForm(id) {
        try {
            // 상세 정보를 가져와야 함 (jobIds 포함)
            const token = document.getElementById('jwt-token').value;
            // AdminController에는 상세 조회 API가 없으므로, 그냥 일반 정보를 사용.
            // 상세 조회가 필요하면 AdminService와 Controller에 추가해야 합니다.
            // 여기서는 임시로 목록의 정보를 사용합니다.
            const questions = await apiFetch(`${API_BASE_URL}/questions`);
            const question = questions.find(q => q.questionId === id);

            if(!question) {
                alert('질문 정보를 찾을 수 없습니다. 목록을 새로고침 해주세요.');
                return;
            }

            await fetchAllJobsForQuestions(); // 직업 목록 로드

            document.getElementById('question-form-wrapper').style.display = 'block';
            document.getElementById('question-form-title').innerText = `질문 수정 (ID: ${id})`;
            document.getElementById('question-submit-btn').innerText = '수정 완료';
            document.getElementById('edit-question-id').value = id;
            document.getElementById('question-text').value = question.questionText;
            document.getElementById('question-type').value = question.questionType;
            document.getElementById('question-enabled').value = question.enabled;

            // jobIds는 별도 API 호출이 필요하나, 현재 없으므로 체크박스 설정은 생략합니다.
            // 이 기능을 완전하게 구현하려면 GET /api/admin/questions/{id} 가 필요합니다.
            alert("주의: 연결된 직업 목록은 불러오지 못했습니다. 수정 시 모든 직업을 다시 선택해야 합니다.");

        } catch(e) { /* 에러 처리 */ }
    }

    async function handleQuestionSubmit(event) {
        event.preventDefault();
        const id = document.getElementById('edit-question-id').value;
        const isUpdate = id !== '';

        const text = document.getElementById('question-text').value;
        const type = document.getElementById('question-type').value;
        const enabled = document.getElementById('question-enabled').value === 'true';
        const jobIds = Array.from(document.querySelectorAll('#job-checkboxes input:checked')).map(cb => Number(cb.value));

        if (jobIds.length === 0) {
            alert('하나 이상의 직업을 선택해야 합니다.');
            return;
        }

        const url = isUpdate ? `${API_BASE_URL}/questions/${id}` : `${API_BASE_URL}/questions`;
        const method = isUpdate ? 'PUT' : 'POST';
        const body = isUpdate
            ? { questionText: text, questionType: type, enabled, jobIds }
            : { questionText: text, questionType: type, jobIds };

        try {
            await apiFetch(url, { method, body: JSON.stringify(body) });
            alert(`질문이 성공적으로 ${isUpdate ? '수정' : '생성'}되었습니다.`);
            resetQuestionForm();
            fetchQuestions();
        } catch (e) { /* 에러 처리 */ }
    }

    async function deleteQuestion(id) {
        if (!confirm(`정말로 ID ${id} 질문을 삭제하시겠습니까?`)) return;
        try {
            await apiFetch(`${API_BASE_URL}/questions/${id}`, { method: 'DELETE' });
            alert('질문이 삭제되었습니다.');
            fetchQuestions();
        } catch (e) { /* 에러 처리 */ }
    }

</script>

</body>
</html>